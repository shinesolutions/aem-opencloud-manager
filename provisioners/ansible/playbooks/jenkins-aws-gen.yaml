---
- name: Generate AEM OpenCloud Manager resources for Jenkins (pipeline Jenkinsfile and shared libraries)
  hosts: all
  gather_facts: no
  connection: local

  tasks:

    ########################################################################
    # Retrieving AEM OpenCloud Configuration artifact for inspection
    # of the available config profiles.
    ########################################################################

    - name: Ensure the existence of AEM OpenCloud Configuration staging directory
      file: path=../../../stage/aem-opencloud-config/
            state=directory

    # TODO: Replace get_url module and gunzip shell command with proper Ansible
    # unarchive module after this bug is fixed in Ansible
    # https://github.com/ansible/ansible/issues/33058 which will allow unarchive
    # module to handle .tar.gz
    # Even though Ansible unarchive module supports zip, we can't use zip in
    # order to preserve consistency with other AEM OpenCloud artifacts which
    # are .tar.gz archives.
    - name: Download AEM OpenCloud Configuration artifact
      get_url:
        url: "{{ aem_opencloud.config.artifact_url }}"
        dest: ../../../stage/aem-opencloud-config.tar.gz
        mode: 0660
    - name: Unarchive gzip artifact due to Ansible limitation
      shell: tar --strip-components=1 -xvzf ../../../stage/aem-opencloud-config.tar.gz --directory ../../../stage/aem-opencloud-config/ warn=False

    ########################################################################
    # Traverse AEM OpenCloud Configuration files and list down all available
    # configuration profiles for each AEM OpenCloud library.
    # These configuration profiles will then be used to structure the generated
    # Jenkins pipelines.
    ########################################################################

    - name: Create a list of Packer AEM configuration profiles
      shell: echo {{ item.path }}
      with_filetree: ../../../stage/aem-opencloud-config/packer-aem/
      when: item.state == 'directory'
      register: packer_aem_profiles

    - name: Create a list of AEM AWS Stack Builder AEM Stack Manager configuration profiles
      shell: echo {{ item.path }}
      with_filetree: ../../../stage/aem-opencloud-config/aem-aws-stack-builder/
      when: item.state == 'directory' and item.path is match ('aem-stack-manager-*')
      register: aem_aws_stack_builder_aem_stack_manager_profiles

    - name: Create a list of AEM AWS Stack Builder AEM Consolidated configuration profiles
      shell: echo {{ item.path }}
      with_filetree: ../../../stage/aem-opencloud-config/aem-aws-stack-builder/
      when: item.state == 'directory' and item.path is match ('aem-consolidated-*')
      register: aem_aws_stack_builder_aem_consolidated_profiles

    - name: Create a list of AEM AWS Stack Builder AEM Full-Set configuration profiles
      shell: echo {{ item.path }}
      with_filetree: ../../../stage/aem-opencloud-config/aem-aws-stack-builder/
      when: item.state == 'directory' and item.path is match ('aem-full-set-*')
      register: aem_aws_stack_builder_aem_full_set_profiles

    - name: Create a list of AEM Stack Manager Messenger configuration profiles
      shell: echo {{ item.path }}
      with_filetree: ../../../stage/aem-opencloud-config/aem-stack-manager-messenger/
      when: item.state == 'directory'
      register: aem_stack_manager_messenger_profiles

    - name: Create a list of AEM Test Suite configuration profiles
      shell: echo {{ item.path }}
      with_filetree: ../../../stage/aem-opencloud-config/aem-test-suite/
      when: item.state == 'directory'
      register: aem_test_suite_profiles

    ########################################################################
    # Generate Jenkins jobs directory structure.
    ########################################################################

    - name: "Create category directories for generated AEM OpenCloud Jenkins jobs"
      file:
        path: ../../../stage/jenkins/jobs/aem-opencloud-{{ aem_opencloud.version }}/{{ item.path }}
        state: directory
        mode: '0776'
      with_filetree: ../../../provisioners/jenkins/jenkinsfiles/aem-opencloud/
      when: item.state == 'directory'

    - name: "Generate AEM OpenCloud Jenkins project's config.xml"
      template:
        src: '../../../templates/ansible/jenkins/config/project.xml.j2'
        dest: "../../../stage/jenkins/jobs/aem-opencloud-{{ aem_opencloud.version }}/config.xml"
        mode: '0644'

    - name: "Create category config.xml for generated AEM OpenCloud Jenkins jobs"
      template:
        src: '../../../templates/ansible/jenkins/config/category.xml.j2'
        dest: "../../../stage/jenkins/jobs/aem-opencloud-{{ aem_opencloud.version }}/{{ item.path }}/config.xml"
        mode: '0644'
      with_filetree: ../../../stage/jenkins/jobs/aem-opencloud-{{ aem_opencloud.version }}/
      when: item.state == 'directory'


    ########################################################################
    # Generate Jenkins jobs directory structure.
    ########################################################################

    - name: "Create category directories for generated AEM OpenCloud Jenkins jobs"
      file:
        path: ../../../stage/jenkins/jobs/aem-opencloud-{{ aem_opencloud.version }}/{{ item.path }}
        state: directory
        mode: '0776'
      with_filetree: ../../../provisioners/jenkins/jenkinsfiles/aem-opencloud/
      when: item.state == 'directory'

    - name: "Generate AEM OpenCloud Jenkins project's config.xml"
      template:
        src: '../../../templates/ansible/jenkins/config/project.xml.j2'
        dest: "../../../stage/jenkins/jobs/aem-opencloud-{{ aem_opencloud.version }}/config.xml"
        mode: '0644'

    - name: "Create category config.xml for generated AEM OpenCloud Jenkins jobs"
      template:
        src: '../../../templates/ansible/jenkins/config/category.xml.j2'
        dest: "../../../stage/jenkins/jobs/aem-opencloud-{{ aem_opencloud.version }}/{{ item.path }}/config.xml"
        mode: '0644'
      with_filetree: ../../../stage/jenkins/jobs/aem-opencloud-{{ aem_opencloud.version }}/
      when: item.state == 'directory'

    ########################################################################
    # Generate the category jobs.
    ########################################################################

    - import_tasks: includes/installation-gen.yaml
      vars:
        aem_aws_stack_builder_aem_consolidated_profiles: aem_aws_stack_builder_aem_consolidated_profiles
        aem_aws_stack_builder_aem_full_set_profiles: aem_aws_stack_builder_aem_full_set_profiles

    - import_tasks: includes/machine-images-gen.yaml
      vars:
        packer_aem_profiles: packer_aem_profiles

    - import_tasks: includes/manage-environments-gen.yaml
      vars:
        aem_aws_stack_builder_aem_stack_manager_profiles: aem_aws_stack_builder_aem_stack_manager_profiles
        aem_aws_stack_builder_aem_consolidated_profiles: aem_aws_stack_builder_aem_consolidated_profiles
        aem_aws_stack_builder_aem_full_set_profiles: aem_aws_stack_builder_aem_full_set_profiles
        aem_stack_manager_messenger_profiles: aem_stack_manager_messenger_profiles
        aem_test_suite_profiles: aem_test_suite_profiles
